#!/bin/bash
set -euo pipefail

SCREENSHOT_DIR="$HOME/.config/retroarch/screenshots"
TIMESTAMP_FILE="$SCREENSHOT_DIR/.screenshot_optimize_last_run"

cd "$SCREENSHOT_DIR" || exit 1

if [[ -f "$TIMESTAMP_FILE" ]]; then
    # Process only new files
    while IFS= read -r -d '' file; do
        echo "Processing new file: $file"
        if ! pngquant --quality=65-80 --ext .png --force "$file" 2>/dev/null; then
            optipng -o5 "$file"
        fi
    done < <(find . -name "*.png" -newer "$TIMESTAMP_FILE" -print0)
else
    # First run - process all files
    while IFS= read -r -d '' file; do
        echo "Processing: $file"
        if ! pngquant --quality=65-80 --ext .png --force "$file" 2>/dev/null; then
            optipng -o5 "$file"
        fi
    done < <(find . -name "*.png" -print0)
fi

# Update timestamp
touch "$TIMESTAMP_FILE"
echo "Screenshot optimization complete at $(date)"
