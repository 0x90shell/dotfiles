#!/usr/bin/env bash
# Recursively convert images to CHD:
# - .iso  -> createdvd (DVD)
# - .cue  -> createcd  (CD, multi-track aware)
# - .gdi  -> createcd  (Dreamcast GDI descriptor)

set -euo pipefail

ROOT="${1:-.}"

command -v chdman >/dev/null 2>&1 || {
  echo "Error: chdman not found in PATH." >&2
  exit 1
}

export LC_ALL=C

# Convert .cue (CD) and .gdi via createcd
find "$ROOT" -type f \( -iname '*.cue' -o -iname '*.gdi' \) -print0 |
while IFS= read -r -d '' src; do
  out="${src%.*}.chd"
  if [[ -e "$out" ]]; then
    echo "Skip (exists): $out"
    continue
  fi
  echo "CD  -> CHD: $src"
  chdman createcd -i "$src" -o "$out"
done

# Convert .iso (DVD) via createdvd
find "$ROOT" -type f -iname '*.iso' -print0 |
while IFS= read -r -d '' src; do
  out="${src%.*}.chd"
  if [[ -e "$out" ]]; then
    echo "Skip (exists): $out"
    continue
  fi
  echo "DVD -> CHD: $src"
  chdman createdvd -i "$src" -o "$out"
done

echo "Done."

