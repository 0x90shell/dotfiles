#!/bin/bash
set -euo pipefail

APP_CLASS="sleek.sleek"

# Find existing Sleek window
kp_xwid="$(wmctrl -lx | awk -v cls="$APP_CLASS" 'BEGIN{IGNORECASE=1} $3 ~ cls {print $1; exit}')"

# Get mouse location
eval "$(xdotool getmouselocation --shell)"
pointer_x="$X"; pointer_y="$Y"

# Get active monitor geometry from xrandr
mapfile -t MONS < <(xrandr --query | awk '
  / connected( primary)? [0-9]+x[0-9]+\+[0-9]+\+[0-9]+/ {
    for (i=1;i<=NF;i++) if ($i ~ /^[0-9]+x[0-9]+\+[0-9]+\+[0-9]+$/) { print $i; break }
  }')

for g in "${MONS[@]}"; do
  wh="${g%%+*}" ; offs="${g#*+}"
  mon_w="${wh%x*}"; mon_h="${wh#*x}"
  mon_x="${offs%%+*}"; mon_y="${offs#*+}"
  if (( pointer_x >= mon_x && pointer_x < mon_x + mon_w && \
        pointer_y >= mon_y && pointer_y < mon_y + mon_h )); then
    target_w="$mon_w"; target_h="$mon_h"
    target_x="$mon_x"; target_y="$mon_y"
    break
  fi
done

move_to_center() {
  local wid="$1"
  read -r win_x win_y win_w win_h < <(xwininfo -id "$wid" | awk '
    /Absolute upper-left X:/{x=$4}
    /Absolute upper-left Y:/{y=$4}
    /Width:/{w=$2}
    /Height:/{h=$2}
    END{print x, y, w, h}')

  # Check if already fully inside target monitor
  if (( win_x >= target_x && win_x + win_w <= target_x + target_w &&
        win_y >= target_y && win_y + win_h <= target_y + target_h )); then
    return 0  # already on correct monitor
  fi

  nx=$(( target_x + (target_w - win_w) / 2 ))
  ny=$(( target_y + (target_h - win_h) / 2 ))
  wmctrl -ir "$wid" -e "0,${nx},${ny},-1,-1"
}

if [[ -n "$kp_xwid" ]]; then
  echo "Sleek is already running, bringing to focus..."
  wmctrl -i -a "$kp_xwid"
  move_to_center "$kp_xwid"
else
  echo "Sleek is not running, starting now..."
  nohup sleek &>/dev/null &
fi

